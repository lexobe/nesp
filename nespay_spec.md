# NesPay 产品规格

## Why：为什么需要 NesPay
从以物易物到货币支付，人类交易效率不断提升，但“陌生人之间如何避免被骗”始终是老问题。现金交易要么当面交割，要么互相赌信用；电商和平台托管虽然提供了中介，却让判责与放款掌握在中心化机构手里，手续费、账户门槛和跨境限制随之而来。NesPay 试图把这些摩擦降到最低——用托管额 `E`（Escrow）和限时争议下的对称没收守卫，把“不给货 / 不付款”转化为透明的经济成本，让交易双方在规则落地前就清楚自己承担的代价。这是一种从“相信对方或平台”转向“相信条款与托管机制”的新范式。

随着托管额和窗口参数被行业接受，第三方可以围绕这些指标推出自动化验收与信用评分服务：按时履约就累积信誉，违约则立即产生可量化的损失。

关键驱动力如下：
- 降低陌生人交易的信任门槛，使“只要具备数字身份”即可安全开单。
- 摆脱贸易双方对银行和平台审批的依赖，方便全球远程协作与跨境结算。
- 支撑公共品项目的“募资＋交付”闭环，让资金拨付与里程碑达成同步可验证。
- 让平台、DAO、自由职业网络一键继承托管安全层，而非重复建设风控系统。
- 协议默认时间窗与守卫沿用白皮书：创建时若传入 0，则采用 `D_due = 86,400s`、`D_rev = 86,400s`、`D_dis = 604,800s`；订单建立后 `D_due/D_rev` 仅能在争议前单调延后，`D_dis` 固定不可延长（托管额 `E` 只增不减）。运营层可在不违反上述约束的前提下，为不同场景制定模板。

## What：NesPay 是什么
NesPay 是一种“可验证协作合同”范式：它通过托管额 `E` 确保交易资金先行锁定，再配上固定时间窗和对称没收威慑，明确什么时候必须交付、什么时候必须验收、逾期如何处理。时间窗与托管的合约规则遵循白皮书：每笔订单在建立/接受时固化 `D_due/D_rev/D_dis`，只有 `D_due/D_rev` 可在争议前单调延后，`D_dis` 固定不变；托管额 `E` 只允许通过补充托管增加。社区或企业可以围绕这些约束，在业务层设计不同模板或治理流程，从而决定自利策略的成本上界。参与者不需要彼此认识，只要遵循合同参数，就能在规定的时间和金额框架内完成交易、退款或没收。NesPay 适用于个人、企业与公共项目——提供标准化的订单模板、托管规则和流程记录，便于第三方审核与争议统计。

NesPay 对用户和集体的含义：
- 个人与团队可以在无信任关系下安全成交，避免依赖中心平台或人工仲裁。
- 机构和 DAO 可以把合同条款公示为托管额与时间窗，形成透明的协作信誉。
- 公共品治理方可以将资金释放绑定于交付状态机，缩短拨款到执行的可信路径。
- 审计与评分服务可以围绕事件流构建“协作信用”与风险监控体系。

## How：核心机制
NesPay 继承 NESP 协议的状态机、不变量和安全守卫，以拉取式资金流支撑自动终局。

状态与金额：
- `Init → Fund → Deliver → Accept | Forfeit → Settle | Timeout` 的前进式状态机，杜绝循环与歧义。
- 托管额 `E` 仅能通过 `depositEscrow` 增加；限时争议期内触发 `timeoutForfeit` 会对称没收托管额，形成“违约即付出成本”的博弈结构。
- 固定时间窗 `D_due`、`D_rev`、`D_dis` 在创建时固化，只允许单调延长（履约/评审），争议窗禁止延长。

资金安全：
- 结算遵循拉取式提现 `withdraw(tokenAddr)`，入口 `nonReentrant` 并严格执行 CEI；任何状态变更只记账到 `withdrawable`。
- 事件日志包括 `OrderCreated`、`EscrowDeposited`、`Accepted`、`Settled`、`Forfeited`、`BalanceCredited`/`BalanceWithdrawn`，保证资金守恒可被实时核对。
- 支持原生 ETH 与主流稳定币；ERC‑20 路径使用 SafeERC20.transferFrom，原生路径要求 `msg.value == amount`。
- 违规守卫：进入争议或终态后触发 `ErrFrozen/ErrInvalidState` 禁止充值或重复结算，确保托管只增不减且终局不可逆。

防护与验证：
- 状态守卫覆盖冻结、终态禁止、金额上限、签名真实性（EIP‑712/1271），确保争议期内不可追加托管。
- 优先处理 `timeoutSettle` 与 `timeoutForfeit`，防止恶意拖延。
- 参数与事件公开化后，可由审计方构建自动校验（托管覆盖率、争议时长、终局类型分布）。

## 价值主张
- **确定终局**：不同意就不结款也不退款，任何终局都由时间窗或双方签名触发，协议自主完成结清、退款或没收。
- **无需许可**：只要有钱包即可发起订单；无需中心平台授权或仲裁介入，适配开放协作。
- **可信中立**：托管规则与时间窗以协议文本呈现，不依赖运营者判断；事件日志可供第三方实时审计。
- **可组合**：可嵌入 DAO 工具、自由职业平台、AA 钱包或 rollup SDK，作为稳定币支付骨干。
- **可治理**：托管策略、时间窗、资费策略可由社区或机构治理，结合事件数据自动调节。
- **效率透明**：托管额度与窗口参数决定自利策略的成本边界，可通过事件数据测算无政府代价变化，支持持续优化。

## 典型用户旅程
- **自由职业者**：客户在创建订单时托管稳定币；交付完成后客户批准或按时间窗自动结算；卖家通过 `withdraw` 领取收益，全程无需信任平台。可通过 AA 钱包(Smart Account) 集成一键签名与社会恢复。
- **公共品项目**：DAO 在 NesPay 中登记里程碑与托管额；执行方按里程碑交付，若出现争议则进入协商或对称没收；所有记录可供资助者实时查看。
- **跨境 B2B**：买方锁定货款并托管至协议，卖方接受订单后按窗口发货；评审期内买方提出异议则双方协商金额或等待争议窗没收；多方团队可复用相同模板。
- **AI 服务 / 订阅**：模型提供方按迭代交付算力或结果，托管额与窗口确保买方可检验输出质量，否则退还或没收，适配高速迭代的交付节奏。
- **陌生人交易平台**：C2C/远程服务市场挂载订单至 NesPay，托管和限时争议替代人工仲裁，降低平台风控成本。
- **A2A 经纪生态**：AI 代理以标准化订单执行任务，按结果积累协作信誉或触发对称没收，构建可控的 agent 经济。

## 参数与治理
- **托管策略**：可在遵守 `E` 只增不减的前提下，设置一次性全额托管或分阶段补充托管；治理可依据事件数据调节阈值与提醒。
- **时间窗配置**：建议以行业工期为基准，履约窗涵盖交付周期，评审窗确保验证时间，争议窗保障协商足够但不会无限拖延。
- **费率与奖励**：可选地在 `withdraw` 过程中提取流动性池费用或协议费；需要时可将其记账为公共品基金。
- **升级与扩展**：合约遵循最小内置原则，可通过新版本部署或代理升级纳入更多资产或扩展接口。
- **多域集成**：通过 rollup/账户抽象 SDK 暴露 `createOrder`/`depositEscrow`/`withdraw` 接口，配合链下服务生成 EIP‑712 签名报文，方便钱包与前端直接调用。

## 观测与审计
- 实时仪表盘可跟踪 `EscrowDeposited` 与 `BalanceCredited` 的金额流向，计算托管覆盖率、争议率、终局分布，并在托管覆盖率低于阈值或争议时长突增时触发冻结、白名单或追加托管要求。

## 采用路线
- **阶段一：封闭沙盒**——在受控 rollup 或私有链环境引入稳定币版本，设定争议率 <5%、没收率 <2%、平均终局时长 <72h 作为放量阈值，同时打磨 UI 与参数默认值。
- **阶段二：开放佣金市场**——为自由职业平台、AI 交付站点提供 API/SDK，支持一键创建订单与事件监控。
- **阶段三：机构与公共品**——与 DAO、基金会合作，将公共资助与里程碑付款迁移到 NesPay，上线协作信用评分。
- **阶段四：跨生态互操作**——通过桥与消息层让不同 rollup 间共享 NesPay 状态，形成广域的无仲裁交易网络。
