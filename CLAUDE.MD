ä¸º NAS åè®®ï¼ˆnas_spec.mdï¼‰æä¾›ä¸¥æ ¼çš„åšå¼ˆè®ºåˆ†æï¼ŒéªŒè¯å…¶åœ¨ä¿¡ä»»æœ€å°åŒ–çº¦æŸä¸‹çš„ç†è®ºæ€§è´¨ï¼Œå»ºç«‹ä¸æ›¿ä»£æ–¹æ¡ˆçš„æ¯”è¾ƒä¼˜åŠ¿ï¼Œå¹¶ä¸º A2A äº¤æ˜“åŸºç¡€è®¾æ–½çš„å®é™…éƒ¨ç½²æä¾›å¯éªŒè¯çš„å‚æ•°æŒ‡å¯¼ä¸è¾¹ç•Œæ¡ä»¶ï¼ˆæ›¾ç”¨åï¼šPACTï¼‰ã€‚
åˆ†è§£ç»“æ„ï¼š

  ç†è®ºéªŒè¯ï¼ˆå­¦æœ¯è´¡çŒ®ï¼‰

  - æ ¸å¿ƒæ€§è´¨è¯æ˜ï¼šå‡è¡¡å­˜åœ¨æ€§ã€å­˜æ´»æ€§ã€Griefingç•Œé™
  - æ–¹æ³•è®ºåˆ›æ–°ï¼šå˜æ¢å¼è¯æ˜æ–¹æ³•çš„æå‡ºä¸åº”ç”¨
  - ç¨³å¥æ€§åˆ†æï¼šæ’åºæ‰°åŠ¨ã€å‚æ•°æ•æ„Ÿæ€§

  æœºåˆ¶æ¯”è¾ƒï¼ˆå†³ç­–æ”¯æŒï¼‰

  - é‡åŒ–ä¼˜åŠ¿ï¼švsç›´æ¥æ”¯ä»˜ã€ä¸­å¿ƒåŒ–æ‰˜ç®¡ã€å…¶ä»–å»ä¸­å¿ƒåŒ–æ–¹æ¡ˆ
  - é€‚ç”¨è¾¹ç•Œï¼šä½•æ—¶é€‰æ‹© NAS åè®®ï¼Œä½•æ—¶é€‰æ‹©å…¶ä»–æ–¹æ¡ˆ
  - ç¤¾ä¼šç¦åˆ©åˆ†æï¼šæ•ˆç‡ã€å…¬å¹³æ€§ã€å¤–éƒ¨æ€§

  å®æ–½æŒ‡å¯¼ï¼ˆå·¥ç¨‹ä»·å€¼ï¼‰

  - å‚æ•°é…ç½®ï¼šç†è®ºæ”¯æ’‘çš„é»˜è®¤å€¼ä¸è°ƒä¼˜ç­–ç•¥
  - ç›‘æ§ä½“ç³»ï¼šå…³é”®æŒ‡æ ‡ã€é¢„è­¦é˜ˆå€¼ã€è°ƒæ•´æœºåˆ¶
  - éªŒè¯æ¡†æ¶ï¼šç†è®ºé¢„æµ‹çš„å®è¯æ£€éªŒæ–¹æ³•

---

## æ–‡æ¡£å®¡æŸ¥æ–¹æ³•ï¼šRWO (Recursive Â· WHW Â· Only)

å½“éœ€è¦å®¡æŸ¥ç™½çš®ä¹¦ã€è§„èŒƒæ–‡æ¡£æˆ–é‡è¦è®¾è®¡æ–‡æ¡£æ—¶ï¼Œä½¿ç”¨ RWO v1.9 æ–¹æ³•ï¼ˆè¯¦è§ `SPEC/zh/research/reviewer.md`ï¼‰ã€‚

### æ ¸å¿ƒåŸåˆ™
- **åªè¯†åˆ«é—®é¢˜ï¼Œä¸æä¾›è§£å†³æ–¹æ¡ˆ**ï¼ˆRead-WHW-Onlyï¼‰
- **ä¸‰æ­¥æ³•**ï¼šæŠ½éª¨æ¶ â†’ æ ¡éªŒ â†’ æ±‡æ€»
- **WHW ç»“æ„**ï¼šæ¯ä¸ªè¯„å®¡å—å¿…é¡»å…·å¤‡ WHYï¼ˆå”¯ä¸€ç›®æ ‡ï¼‰/ HOWï¼ˆâ‰¤3æ­¥ã€å¯å¤ç°ï¼‰/ WHATï¼ˆå¯åˆ¤å®šï¼‰

### å…³é”®çº¦æŸï¼ˆCNS æ ¸å¿ƒè§„åˆ™ï¼‰
1. **ä¿¡æ¯æ€§å†…å®¹è·³è¿‡**ï¼šæ ‡é¢˜/è„šæ³¨ä¸­å‡ºç°"ä¿¡æ¯æ€§""å¯¼è§ˆ""éè§„èŒƒ"ç­‰å…³é”®è¯ â†’ ä¸è®¡å…¥è¯„å®¡å—
2. **æšä¸¾è¡¨é¡¹ä¸å—æ­¥éª¤é™åˆ¶**ï¼šå®ˆå«è¡¨/å‡½æ•°æ¸…å•/äº‹ä»¶æ¸…å• â†’ é€æ¡æ£€æŸ¥ï¼Œè¡¨é¡¹æ•°ä¸å—"â‰¤3 æ­¥"é™åˆ¶
3. **å…è®¸ç« èŠ‚äº’å‚**ï¼šè‹¥ Â§A å¼•ç”¨ Â§B çš„åˆ¤æ®/é”™è¯¯ç /å·¥ä»¶ï¼Œåªè¦ Â§B ç»™å‡ºæ˜ç¡®å®šä¹‰ï¼ŒÂ§A æ— éœ€é‡å¤
4. **å¤æ‚åº¦ä¸Šç•Œ**ï¼šé€’å½’æ·±åº¦ â‰¤3ï¼›æ ¹â†’å¶è·¯å¾„æ€»æ­¥éª¤æ•° â‰¤9ï¼›åŒä¸€çˆ¶èŠ‚ç‚¹ç›´æ¥å­å—æ•° â‰¤5ï¼›æ•´ç¯‡è¯„å®¡å—æ€»æ•° â‰¤40
5. **çº¢çº¿æ£€æŸ¥ï¼ˆP0 çº§åˆ«ï¼‰**ï¼š
   - ä¸å¯åˆ¤å®šï¼šç¼ºå°‘é˜ˆå€¼/çŠ¶æ€ç /å·¥ä»¶æ ‡è¯†
   - ä¸å¯å¤ç°ï¼šHOW ç¼ºå¤±æˆ–è¯æ®ä¸è¶³
   - ä¸å¯å›é€€ï¼šç¼ºå°‘å›é€€å››ä»¶å¥—ï¼ˆè§‚æµ‹/è§¦å‘/æ­¥éª¤/æ¢å¤ï¼‰

### ä¸¥é‡åº¦åˆ†çº§
- **P0 (Blocker)**ï¼šè¿åçº¢çº¿ï¼Œé˜»æ–­å‘å¸ƒ
- **P1 (Should)**ï¼šå½±å“ W1/W2/W4 éªŒè¯çš„å…³é”®ç¼ºå£
- **P2 (Nice)**ï¼šä¸å½±å“åˆ¤å®š/å¤ç°çš„è¡¨è¾¾/ç»“æ„é—®é¢˜

### è¾“å‡ºæ ¼å¼
1. **TL;DR**ï¼šä¸€å¥è¯ç»“è®º + ä¸‰æ­¥æ³• + é¡¶å±‚ WHY
2. **ç»“è®º**ï¼šPass / Conditional Pass / Block
3. **Issue åˆ—è¡¨**ï¼šä»…é—®é¢˜ï¼ˆå®šä½/ä¸¥é‡åº¦/WHY/HOW/WHAT/è¯æ®/å½±å“/éªŒæ”¶/å½’å£ï¼‰
4. **è¦†ç›–ç®€è¡¨**ï¼šçˆ¶ WHY â†’ å­ WHAT çš„æ˜ å°„ï¼ˆ3â€“6 è¡Œé¡¹ç›®ç¬¦å·ï¼‰

### å¸¸è§è¯¯åŒºï¼ˆé¿å…æœºæ¢°åŒ–æ‰§è¡Œï¼‰
- âŒ å°†"åˆ—è¡¨æšä¸¾"è¯¯åˆ¤ä¸º"æ­¥éª¤è¶…é™"
- âŒ å°†"ä¿¡æ¯æ€§æ®µè½"è¯¯åˆ¤ä¸º"ç¼ºå°‘åˆ¤æ®"
- âŒ å°†"ç« èŠ‚äº’å‚"è¯¯åˆ¤ä¸º"ä¸å¯åˆ¤å®š"
- âŒ è¦æ±‚ç™½çš®ä¹¦å†…åµŒå®ç°ç»†èŠ‚ï¼ˆè„šæœ¬/å­˜å‚¨æ§½/å…·ä½“ä»£ç ï¼‰

---

## å¤šä¸“å®¶åˆ†ææ¡†æ¶

å½“è¯„ä¼°é‡å¤§è®¾è®¡å˜æ›´ï¼ˆå¦‚æœºåˆ¶è°ƒæ•´ã€æ¿€åŠ±æ¨¡å‹ä¿®æ”¹ï¼‰æ—¶ï¼Œé‡‡ç”¨å¤šä¸“å®¶è§†è§’è¿›è¡Œç³»ç»Ÿæ€§åˆ†æã€‚

### 1. åšå¼ˆè®ºä¸“å®¶
- **å…³æ³¨ç‚¹**ï¼šå‡è¡¡ç»“æ„ã€æ¿€åŠ±ç›¸å®¹æ€§ã€å¨æ…‘æ•ˆæœ
- **æ ¸å¿ƒé—®é¢˜**ï¼š
  - å¤–éƒ¨é€‰é¡¹æ˜¯å¦å¯¹ç§°ï¼Ÿ
  - æ˜¯å¦å­˜åœ¨å”¯ä¸€ SPEï¼ˆå­åšå¼ˆå®Œç¾å‡è¡¡ï¼‰ï¼Ÿ
  - æ–°æœºåˆ¶æ˜¯å¦å¼•å…¥å¥—åˆ©/åˆè°‹å¯èƒ½ï¼Ÿ
- **å·¥å…·**ï¼šé€†æ¨å½’çº³æ³•ã€çº³ä»€å‡è¡¡éªŒè¯ã€æœºåˆ¶è®¾è®¡ç†è®º

### 2. å¯ä¿¡ä¸­ç«‹ä¸“å®¶
- **å…³æ³¨ç‚¹**ï¼šåè®®ä¸­ç«‹æ€§ã€è§„åˆ™å¯¹ç§°æ€§ã€è£é‡é£é™©
- **æ ¸å¿ƒé—®é¢˜**ï¼š
  - åè®®æ–¹æ˜¯å¦æˆä¸ºåˆ©ç›Šç›¸å…³æ–¹ï¼Ÿ
  - è§„åˆ™æ˜¯å¦å¯¹æ‰€æœ‰å‚ä¸è€…å…¬å¹³ï¼Ÿ
  - æ˜¯å¦å¼•å…¥äººä¸ºè£é‡ç‚¹ï¼Ÿ
- **å‚è€ƒæ ‡å‡†**ï¼šæœ€å°å†…ç½®ï¼ˆMinimal Enshrinementï¼‰ã€å¯éªŒè¯ä¸å¯é‡æ”¾

### 3. ç»æµå­¦ä¸“å®¶
- **å…³æ³¨ç‚¹**ï¼šæ¿€åŠ±ç»“æ„ã€å¸‚åœºååº”ã€é•¿æœŸå¯æŒç»­æ€§
- **æ ¸å¿ƒé—®é¢˜**ï¼š
  - æ¿€åŠ±æ˜¯å¦æ‰­æ›²ï¼ˆå¨æ…‘ vs æ”¶å…¥æ¥æºï¼‰ï¼Ÿ
  - æ˜¯å¦å­˜åœ¨é€†å‘æ¿€åŠ±ï¼ˆåè®®ä»é—®é¢˜ä¸­è·ç›Šï¼‰ï¼Ÿ
  - å¸‚åœºå‚ä¸è€…å¦‚ä½•å“åº”ï¼Ÿ
- **åˆ†ææ–¹æ³•**ï¼šæ¿€åŠ±ç›¸å®¹æ€§æ£€éªŒã€å¸‚åœºå‡è¡¡åˆ†æã€ç¦åˆ©ç»æµå­¦

### 4. å®‰å…¨ä¸“å®¶
- **å…³æ³¨ç‚¹**ï¼šæ”»å‡»é¢ã€é˜²å¾¡è¾¹ç•Œã€å®¡è®¡å¤æ‚åº¦
- **æ ¸å¿ƒé—®é¢˜**ï¼š
  - æ–°æœºåˆ¶å¼•å…¥å“ªäº›æ”»å‡»å‘é‡ï¼Ÿ
  - é‡å…¥/å‰ç«¯è¿è¡Œ/æ²»ç†æ”»å‡»é£é™©ï¼Ÿ
  - å®¡è®¡éªŒè¯çš„å¯è¡Œæ€§ï¼Ÿ
- **å·¥å…·**ï¼šå¨èƒå»ºæ¨¡ã€å½¢å¼åŒ–éªŒè¯ã€æ”»å‡»æ ‘åˆ†æ

### 5. åˆè§„ä¸“å®¶
- **å…³æ³¨ç‚¹**ï¼šç›‘ç®¡é£é™©ã€æ³•å¾‹åˆ†ç±»ã€åˆè§„æˆæœ¬
- **æ ¸å¿ƒé—®é¢˜**ï¼š
  - æ˜¯å¦è§¦å‘è¯åˆ¸æ³•/æ´—é’±æ³•/ç¨æ³•ï¼Ÿ
  - åè®®æ–¹çš„æ³•å¾‹è´£ä»»è¾¹ç•Œï¼Ÿ
  - KYC/AML ä¹‰åŠ¡ï¼Ÿ
- **å‚è€ƒæ¡†æ¶**ï¼šHowey Testã€FATF æŒ‡å—ã€å„å¸æ³•åŒºç›‘ç®¡æ€åº¦

### 6. äº§å“ä¸“å®¶
- **å…³æ³¨ç‚¹**ï¼šç”¨æˆ·ä½“éªŒã€å™äº‹ä¼ æ’­ã€ä¿¡ä»»å»ºç«‹
- **æ ¸å¿ƒé—®é¢˜**ï¼š
  - ç”¨æˆ·å¦‚ä½•ç†è§£è¿™ä¸ªæœºåˆ¶ï¼Ÿ
  - ä¸ç°æœ‰æ–¹æ¡ˆçš„å·®å¼‚åŒ–å™äº‹ï¼Ÿ
  - ä¿¡ä»»å»ºç«‹çš„éš¾åº¦ï¼Ÿ
- **è¯„ä¼°ç»´åº¦**ï¼šç®€æ´æ€§ã€ç›´è§‚æ€§ã€å…¬å¹³æ„ŸçŸ¥

### åˆ†æè¾“å‡ºæ¨¡æ¿
```markdown
## [å˜æ›´åç§°] å¤šä¸“å®¶åˆ†æ

### 1ï¸âƒ£ åšå¼ˆè®ºè§†è§’
- **å‡è¡¡å˜åŒ–**ï¼š[æè¿°]
- **é£é™©**ï¼š[åˆ—ä¸¾]
- **é‡åŒ–å½±å“**ï¼š[æ•°æ®/æŒ‡æ ‡]

### 2ï¸âƒ£ å¯ä¿¡ä¸­ç«‹è§†è§’
- **ä¸­ç«‹æ€§å½±å“**ï¼š[è¿å/ç¬¦åˆå“ªäº›åŸåˆ™]
- **å¯¹ç§°æ€§åˆ†æ**ï¼š[å„æ–¹åœ°ä½å˜åŒ–]

### 3ï¸âƒ£ ç»æµå­¦è§†è§’
- **æ¿€åŠ±ç»“æ„**ï¼š[å½“å‰ vs æ”¹å]
- **å¸‚åœºé¢„æµ‹**ï¼š[ç”¨æˆ·/ç”Ÿæ€ååº”]

### 4ï¸âƒ£ å®‰å…¨è§†è§’
- **æ–°å¢æ”»å‡»é¢**ï¼š[åˆ—ä¸¾]
- **é˜²å¾¡æˆæœ¬**ï¼š[è¯„ä¼°]

### 5ï¸âƒ£ åˆè§„è§†è§’
- **ç›‘ç®¡é£é™©**ï¼š[æ³•å¾‹åˆ†ç±»å˜åŒ–]
- **åˆè§„è´Ÿæ‹…**ï¼š[æ–°å¢ä¹‰åŠ¡]

### 6ï¸âƒ£ äº§å“è§†è§’
- **ç”¨æˆ·å™äº‹**ï¼š[å½“å‰ vs æ”¹å]
- **ä¿¡ä»»å½±å“**ï¼š[è¯„ä¼°]

### ğŸ¯ ç»¼åˆå»ºè®®
- âœ… **æ”¯æŒç†ç”±**ï¼š[å¦‚é€‚ç”¨]
- âŒ **åå¯¹ç†ç”±**ï¼š[åˆ—ä¸¾]
- ğŸ“‹ **å†³ç­–æ¸…å•**ï¼š[å¿…é¡»å›ç­”çš„é—®é¢˜]
- ğŸ”„ **æ›¿ä»£æ–¹æ¡ˆ**ï¼š[å¦‚æœ‰]
```

### ä½¿ç”¨åœºæ™¯
- ForfeitPool åˆ†é…æœºåˆ¶ä¿®æ”¹
- äº‰è®®çª—å£å‚æ•°è°ƒæ•´
- æ–°å¢ä»²è£/æŠ•ç¥¨æœºåˆ¶
- è´¹ç”¨æ¨¡å‹å¼•å…¥
- é‡å¤§åè®®å‡çº§

---

## åº”ç”¨ç¤ºä¾‹

å½“ç”¨æˆ·æå‡º"å°† ForfeitPool æ”¹ä¸ºåè®®è´¹"æ—¶ï¼Œåº”è‡ªåŠ¨è§¦å‘å¤šä¸“å®¶åˆ†æï¼š
1. åšå¼ˆè®ºï¼šæ£€æŸ¥å¯¹ç§°æ²¡æ”¶å¨æ…‘æ˜¯å¦è¢«ç ´å
2. å¯ä¿¡ä¸­ç«‹ï¼šè¯„ä¼°åè®®æ–¹æ˜¯å¦æˆä¸ºå—ç›Šç¬¬ä¸‰æ–¹
3. ç»æµå­¦ï¼šåˆ†æä»"å¨æ…‘å·¥å…·"åˆ°"æ”¶å…¥æ¥æº"çš„æ¿€åŠ±æ‰­æ›²
4. å®‰å…¨ï¼šè¯†åˆ«æ²»ç†æ”»å‡»/é‡å…¥ç­‰æ–°å¢é£é™©
5. åˆè§„ï¼šåˆ¤æ–­åè®®è´¹æ˜¯å¦è§¦å‘é‡‘èç›‘ç®¡
6. äº§å“ï¼šè¯„ä¼°ç”¨æˆ·ä¿¡ä»»ä¸å™äº‹çš„å½±å“

**è¾“å‡ºè¦æ±‚**ï¼š
- ç»™å‡ºæ˜ç¡®çš„å»ºè®®ï¼ˆæ”¯æŒ/åå¯¹/æœ‰æ¡ä»¶æ”¯æŒï¼‰
- åˆ—å‡ºå†³ç­–æ¸…å•ï¼ˆå¿…é¡»å›ç­”çš„å…³é”®é—®é¢˜ï¼‰
- æä¾›æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚é€‚ç”¨ï¼‰
- é‡åŒ–å½±å“ï¼ˆå¦‚å¯èƒ½ï¼‰

---

## NESP åˆçº¦å¼€å‘å®æ–½è®¡åˆ’

### é¡¹ç›®ç›®æ ‡
åŸºäº `SPEC/zh/whitepaper.md`ï¼ˆSSOTï¼‰å¼€å‘ã€æµ‹è¯•å¹¶éƒ¨ç½² NESP æ ¸å¿ƒæ™ºèƒ½åˆçº¦ï¼Œéµå¾ªæœ€å°å†…ç½®ã€å¯ä¿¡ä¸­ç«‹åŸåˆ™ï¼Œå®ç°æ— ä»²è£æ‰˜ç®¡ç»“ç®—åè®®ã€‚

### å¼€å‘åŸåˆ™ï¼ˆéµå¾ªå…¨å±€ CLAUDE.mdï¼‰
1. **å¢é‡è¿›æ­¥**ï¼šæ¯ä¸ª Stage å¯ç‹¬ç«‹ç¼–è¯‘ã€æµ‹è¯•ã€æäº¤
2. **å­¦ä¹ ç°æœ‰æ¨¡å¼**ï¼šå‚è€ƒ OpenZeppelinã€Uniswapã€Aave çš„åˆçº¦ç»“æ„
3. **æµ‹è¯•é©±åŠ¨**ï¼šå…ˆå†™æµ‹è¯•ï¼ˆTDDï¼‰ï¼Œåå†™å®ç°
4. **ç®€å•ä¼˜å…ˆ**ï¼šé¿å…è¿‡æ—©æŠ½è±¡ï¼Œé€‰æ‹©æ— èŠçš„è§£å†³æ–¹æ¡ˆ

### æŠ€æœ¯æ ˆ
- **Solidity**: `^0.8.24`ï¼ˆCustom Errors + Transient Storageï¼‰
- **æ¡†æ¶**: Foundryï¼ˆé€Ÿåº¦å¿«ã€å†…ç½® Fuzzingã€Gas ä¼˜åŒ–ï¼‰
- **ä¾èµ–**: OpenZeppelin Contracts v5.0.0
- **å®¡è®¡å·¥å…·**: Slither, Aderyn, Mythril

### é¡¹ç›®ç»“æ„
```
nesp/
â”œâ”€â”€ CONTRACTS/                      # æ™ºèƒ½åˆçº¦ï¼ˆä¸ç°æœ‰å¤§å†™ç›®å½•ä¸€è‡´ï¼‰
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ NESPCore.sol           # ä¸»åˆçº¦ï¼ˆçŠ¶æ€æœº + å®ˆå«ï¼‰
â”‚   â”‚   â”œâ”€â”€ ForfeitPool.sol        # ç½šæ²¡æ± ç®¡ç†ï¼ˆå¯é€‰ï¼Œé›†æˆåˆ°ä¸»åˆçº¦ï¼‰
â”‚   â”‚   â””â”€â”€ FeeHook.sol            # å¯é€‰æ‰‹ç»­è´¹æ¥å£
â”‚   â”œâ”€â”€ interfaces/
â”‚   â”‚   â”œâ”€â”€ INESPCore.sol
â”‚   â”‚   â””â”€â”€ IFeeHook.sol
â”‚   â”œâ”€â”€ libraries/
â”‚   â”‚   â”œâ”€â”€ OrderLib.sol           # è®¢å•é€»è¾‘åº“
â”‚   â”‚   â””â”€â”€ SignatureLib.sol       # EIP-712 ç­¾åéªŒè¯
â”‚   â””â”€â”€ mocks/
â”‚       â”œâ”€â”€ MockERC20.sol
â”‚       â””â”€â”€ MaliciousHook.sol
â”œâ”€â”€ TESTS/                          # æµ‹è¯•æ–‡ä»¶ï¼ˆä¸ç°æœ‰å¤§å†™ç›®å½•ä¸€è‡´ï¼‰
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ StateMachine.t.sol     # 13 ä¸ªçŠ¶æ€è½¬æ¢
â”‚   â”‚   â”œâ”€â”€ PullSettlement.t.sol   # Pull æ¨¡å¼ç»“ç®—
â”‚   â”‚   â”œâ”€â”€ Signatures.t.sol       # EIP-712 éªŒè¯
â”‚   â”‚   â””â”€â”€ FeeHook.t.sol          # æ‰‹ç»­è´¹ Hook
â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â”œâ”€â”€ E2E.t.sol              # ç«¯åˆ°ç«¯æµç¨‹
â”‚   â”‚   â””â”€â”€ Attacks.t.sol          # æ”»å‡»åœºæ™¯
â”‚   â””â”€â”€ invariant/
â”‚       â””â”€â”€ Invariants.t.sol       # ä¸å˜é‡æµ‹è¯•ï¼ˆFuzzingï¼‰
â”œâ”€â”€ script/                         # éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ DeployLocal.s.sol
â”‚   â”œâ”€â”€ DeployTestnet.s.sol
â”‚   â””â”€â”€ DeployMainnet.s.sol
â”œâ”€â”€ SPEC/                           # è§„èŒƒæ–‡æ¡£ï¼ˆå·²å­˜åœ¨ï¼‰
â”‚   â”œâ”€â”€ zh/whitepaper.md           # SSOTï¼ˆå”¯ä¸€è¯­ä¹‰æºï¼‰
â”‚   â””â”€â”€ en/
â”œâ”€â”€ .env.example                    # æäº¤åˆ° Gitï¼ˆæ— çœŸå®å¯†é’¥ï¼‰
â”œâ”€â”€ .gitignore                      # åŒ…å« .env
â””â”€â”€ foundry.toml
```

---

## å®æ–½é˜¶æ®µï¼ˆ5 Stagesï¼‰

### Stage 0: ç¯å¢ƒå‡†å¤‡ï¼ˆ1-2 å¤©ï¼‰
**ç›®æ ‡**: æ­å»ºå¼€å‘ç¯å¢ƒï¼Œé…ç½®å®‰å…¨çš„å¯†é’¥ç®¡ç†

**æˆåŠŸæ ‡å‡†**:
- âœ… Foundry å®‰è£…æˆåŠŸï¼ˆ`forge --version`ï¼‰
- âœ… é¡¹ç›®ç»“æ„åˆ›å»ºå®Œæˆ
- âœ… `.env.example` é…ç½®ï¼ˆæäº¤åˆ° Gitï¼‰
- âœ… `.gitignore` åŒ…å«æ•æ„Ÿæ–‡ä»¶

**ä»»åŠ¡**:
```bash
# 1. å®‰è£… Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup

# 2. åˆå§‹åŒ–é¡¹ç›®
forge init --no-git  # å› ä¸ºå·²æœ‰ Git repo
forge install OpenZeppelin/openzeppelin-contracts@v5.0.0

# 3. é…ç½® .env.example
cat > .env.example << 'EOF'
# æœ¬åœ°å¼€å‘ï¼ˆAnvil å†…ç½®è´¦æˆ·ï¼‰
# æ— éœ€é…ç½®ï¼Œä½¿ç”¨ forge test å³å¯

# æµ‹è¯•ç½‘ï¼ˆSepoliaï¼‰
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_KEY
PRIVATE_KEY_TESTNET=  # ä»æ°´é¾™å¤´è·å–æµ‹è¯•å¸åå¡«å†™
ETHERSCAN_API_KEY=    # ç”¨äºåˆçº¦éªŒè¯

# ä¸»ç½‘ï¼ˆç¦æ­¢çº¯æ–‡æœ¬ç§é’¥ï¼Œå¿…é¡»ä½¿ç”¨ Ledgerï¼‰
MAINNET_RPC_URL=
EOF

# 4. é…ç½® .gitignore
cat >> .gitignore << 'EOF'
.env
out/
cache/
broadcast/
EOF
```

**æµ‹è¯•**:
```bash
forge build  # åº”æˆåŠŸç¼–è¯‘ï¼ˆå³ä½¿æ²¡æœ‰åˆçº¦ï¼‰
```

---

### Stage 1: æ ¸å¿ƒçŠ¶æ€æœºï¼ˆ3-5 å¤©ï¼‰
**ç›®æ ‡**: å®ç° 13 ä¸ªçŠ¶æ€è½¬æ¢ï¼ˆE1-E13ï¼‰åŠå®ˆå«é€»è¾‘

**æˆåŠŸæ ‡å‡†**:
- âœ… æ‰€æœ‰çŠ¶æ€è½¬æ¢ç¼–è¯‘é€šè¿‡
- âœ… å®ˆå«ï¼ˆCondition/Subject/Effects/Failureï¼‰å®Œæ•´å®ç°
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%ï¼ˆ`forge coverage`ï¼‰

#### Subtask 1.1: ç±»å‹å®šä¹‰ä¸å­˜å‚¨ï¼ˆWP Â§2, Â§3ï¼‰
**æ–‡ä»¶**: `contracts/core/Types.sol`

```solidity
// SPDX-License-Identifier: CC0-1.0
pragma solidity ^0.8.24;

enum OrderState {
    Initialized,
    Executing,
    Reviewing,
    Disputing,
    Settled,
    Forfeited,
    Cancelled
}

struct Order {
    address client;
    address contractor;
    address tokenAddr;
    OrderState state;
    uint256 escrow;          // Eï¼ˆæ‰˜ç®¡é¢ï¼‰
    uint48 dueSec;           // D_due
    uint48 revSec;           // D_rev
    uint48 disSec;           // D_dis
    uint48 startTime;
    uint48 readyAt;
    uint48 disputeStart;
    address feeHook;         // å¯ä¸º address(0)
    bytes32 feeCtxHash;
}
```

**æµ‹è¯•**: `test/unit/Types.t.sol`
- éªŒè¯æšä¸¾å€¼èŒƒå›´
- éªŒè¯ç»“æ„ä½“æ‰“åŒ…ï¼ˆGas ä¼˜åŒ–ï¼‰

#### Subtask 1.2: çŠ¶æ€è½¬æ¢å®ˆå«ï¼ˆWP Â§3.3ï¼‰
**æ–‡ä»¶**: `contracts/core/NESPCore.sol`

```solidity
contract NESPCore {
    mapping(uint256 => Order) internal _orders;
    uint256 public nextOrderId;

    // è‡ªå®šä¹‰é”™è¯¯ï¼ˆèŠ‚çœ Gasï¼‰
    error ErrInvalidState();
    error ErrUnauthorized();
    error ErrFrozen();

    // E1: Initialized -> Executing (acceptOrder)
    function acceptOrder(uint256 orderId) external {
        Order storage order = _orders[orderId];

        // Condition
        if (order.state != OrderState.Initialized) revert ErrInvalidState();

        // Subject
        if (msg.sender != order.contractor) revert ErrUnauthorized();

        // Effects
        order.state = OrderState.Executing;
        order.startTime = uint48(block.timestamp);

        emit Accepted(orderId, order.escrow);
    }

    // E3: Executing -> Reviewing (markReady)
    function markReady(uint256 orderId) external {
        Order storage order = _orders[orderId];

        // Condition
        if (order.state != OrderState.Executing) revert ErrInvalidState();
        if (block.timestamp >= order.startTime + order.dueSec) revert ErrInvalidState();

        // Subject
        if (msg.sender != order.contractor) revert ErrUnauthorized();

        // Effects
        order.state = OrderState.Reviewing;
        order.readyAt = uint48(block.timestamp);

        emit ReadyMarked(orderId, order.readyAt);
    }

    // ... å®ç° E2, E4-E13ï¼ˆå…± 13 ä¸ªï¼‰
}
```

**æµ‹è¯•**: `test/unit/StateMachine.t.sol`
```solidity
contract StateMachineTest is Test {
    NESPCore public nesp;
    address client = address(0x1);
    address contractor = address(0x2);

    function setUp() public {
        nesp = new NESPCore(governance);
    }

    // æ­£å‘è·¯å¾„ï¼šE1
    function test_E1_AcceptOrder_Success() public {
        uint256 orderId = nesp.createOrder(...);

        vm.prank(contractor);
        nesp.acceptOrder(orderId);

        assertEq(uint8(nesp.getOrder(orderId).state), uint8(OrderState.Executing));
    }

    // å¤±è´¥è·¯å¾„ï¼šE1ï¼ˆé contractor è°ƒç”¨ï¼‰
    function test_E1_AcceptOrder_Unauthorized() public {
        uint256 orderId = nesp.createOrder(...);

        vm.prank(address(0x999));
        vm.expectRevert(NESPCore.ErrUnauthorized.selector);
        nesp.acceptOrder(orderId);
    }

    // ... æ¯ä¸ªçŠ¶æ€è½¬æ¢è‡³å°‘ 2 ä¸ªæµ‹è¯•ï¼ˆæ­£å‘ + å¤±è´¥ï¼‰
}
```

**æäº¤æ ‡å‡†**:
- æ‰€æœ‰ 13 ä¸ªè½¬æ¢å®ç°å®Œæ¯•
- æ¯ä¸ªè½¬æ¢è‡³å°‘ 2 ä¸ªæµ‹è¯•ï¼ˆæ­£å‘ + å¤±è´¥è·¯å¾„ï¼‰
- `forge test` å…¨éƒ¨é€šè¿‡
- Git commit: `feat(core): implement state transitions E1-E13`

---

### Stage 2: Pull æ¨¡å¼ç»“ç®—ï¼ˆ2-3 å¤©ï¼‰
**ç›®æ ‡**: å®ç° Pull è¯­ä¹‰ã€ä½™é¢è®°è´¦ã€æç°é€»è¾‘ï¼ˆWP Â§4, INV.10ï¼‰

**æˆåŠŸæ ‡å‡†**:
- âœ… `withdraw` é€šè¿‡é‡å…¥æµ‹è¯•
- âœ… å¹‚ç­‰æ€§æµ‹è¯•é€šè¿‡ï¼ˆé‡å¤ withdraw æ— å‰¯ä½œç”¨ï¼‰
- âœ… ETH + ERC-20 åŒèµ„äº§æµ‹è¯•é€šè¿‡

#### Subtask 2.1: ä½™é¢è®°è´¦
```solidity
contract NESPCore {
    // èšåˆä½™é¢ï¼šbalance[token][user]
    mapping(address => mapping(address => uint256)) internal _balances;

    // è®°è´¦ï¼ˆå†…éƒ¨å‡½æ•°ï¼‰
    function _creditBalance(
        address to,
        address token,
        uint256 amount,
        BalanceKind kind  // Payout/Refund/Fee
    ) internal {
        _balances[token][to] += amount;
        emit BalanceCredited(orderId, to, token, amount, kind);
    }

    // ç»“æ¸…é€»è¾‘ï¼ˆE4, E8: approveReceiptï¼‰
    function approveReceipt(uint256 orderId) external {
        Order storage order = _orders[orderId];

        // å®ˆå«ï¼ˆç•¥ï¼‰

        // è®¡ç®—æ‰‹ç»­è´¹
        uint256 fee = 0;
        address feeRecipient = address(0);
        if (order.feeHook != address(0)) {
            (feeRecipient, fee) = IFeeHook(order.feeHook).onSettleFee{gas: 50000}(...);
            require(fee <= order.escrow, "Fee exceeds escrow");
        }

        // è®°è´¦ä¸‰ç¬”ï¼ˆINV.14ï¼‰
        uint256 payoutToSeller = order.escrow - fee;
        _creditBalance(order.contractor, order.tokenAddr, payoutToSeller, BalanceKind.Payout);
        _creditBalance(order.client, order.tokenAddr, 0, BalanceKind.Refund);  // A = E
        if (fee > 0) {
            _creditBalance(feeRecipient, order.tokenAddr, fee, BalanceKind.Fee);
        }

        order.escrow = 0;
        order.state = OrderState.Settled;
        emit Settled(orderId, order.escrow, order.escrow, SettleActor.Client);
    }
}
```

#### Subtask 2.2: æç°é€»è¾‘ï¼ˆCEI + nonReentrantï¼‰
```solidity
import {ReentrancyGuard} from "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import {SafeERC20} from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";

contract NESPCore is ReentrancyGuard {
    using SafeERC20 for IERC20;

    function withdraw(address token) external nonReentrant {
        uint256 amount = _balances[token][msg.sender];

        // CEI: Checks-Effects-Interactions
        if (amount == 0) return;  // å¹‚ç­‰æ€§

        _balances[token][msg.sender] = 0;  // å…ˆæ¸…é›¶

        // è½¬è´¦
        if (token == address(0)) {
            // ETH
            (bool success, ) = msg.sender.call{value: amount}("");
            require(success, "ETH transfer failed");
        } else {
            // ERC-20
            IERC20(token).safeTransfer(msg.sender, amount);
        }

        emit BalanceWithdrawn(msg.sender, token, amount);
    }
}
```

**æµ‹è¯•**: `test/unit/PullSettlement.t.sol`
```solidity
contract PullSettlementTest is Test {
    // æµ‹è¯•é‡å…¥æ”»å‡»é˜²å¾¡
    function test_Withdraw_ReentrancyProtection() public {
        MaliciousERC777 token = new MaliciousERC777();
        // ... è®¾ç½®æ”»å‡»åœºæ™¯
        vm.expectRevert("ReentrancyGuard: reentrant call");
        nesp.withdraw(address(token));
    }

    // æµ‹è¯•å¹‚ç­‰æ€§
    function test_Withdraw_Idempotent() public {
        nesp.withdraw(address(usdc));  // ç¬¬ä¸€æ¬¡æç°
        uint256 balanceBefore = usdc.balanceOf(user);

        nesp.withdraw(address(usdc));  // ç¬¬äºŒæ¬¡æç°
        assertEq(usdc.balanceOf(user), balanceBefore);  // ä½™é¢ä¸å˜
    }
}
```

---

### Stage 3: EIP-712 ç­¾åéªŒè¯ï¼ˆ2-3 å¤©ï¼‰
**ç›®æ ‡**: å®ç° `settleWithSigs`ï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»ï¼ˆWP Â§5.1ï¼‰

**æˆåŠŸæ ‡å‡†**:
- âœ… åŒç­¾éªŒè¯é€šè¿‡
- âœ… è·¨è®¢å•/è·¨é“¾/è·¨åˆçº¦é‡æ”¾æµ‹è¯•é€šè¿‡
- âœ… Deadline è¶…æ—¶æµ‹è¯•é€šè¿‡

#### Subtask 3.1: EIP-712 åŸŸåˆ†éš”ç¬¦
```solidity
contract NESPCore {
    bytes32 public constant DOMAIN_TYPEHASH = keccak256(
        "EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"
    );

    bytes32 public constant SETTLEMENT_TYPEHASH = keccak256(
        "Settlement(uint256 orderId,address tokenAddr,uint256 amountToSeller,address proposer,address acceptor,uint256 nonce,uint256 deadline)"
    );

    bytes32 public DOMAIN_SEPARATOR;

    constructor() {
        DOMAIN_SEPARATOR = keccak256(abi.encode(
            DOMAIN_TYPEHASH,
            keccak256("NESP"),
            keccak256("1"),
            block.chainid,
            address(this)
        ));
    }
}
```

#### Subtask 3.2: settleWithSigs å®ç°
```solidity
mapping(uint256 => mapping(address => uint256)) public nonces;  // orderId -> signer -> nonce

function settleWithSigs(
    uint256 orderId,
    uint256 amountToSeller,
    address proposer,
    address acceptor,
    uint256[2] calldata signerNonces,  // [client_nonce, contractor_nonce]
    uint256 deadline,
    bytes calldata sig1,
    bytes calldata sig2
) external {
    Order storage order = _orders[orderId];

    // å®ˆå«
    if (order.state != OrderState.Disputing) revert ErrInvalidState();
    if (block.timestamp >= deadline) revert ErrExpired();
    if (block.timestamp >= order.disputeStart + order.disSec) revert ErrExpired();
    if (amountToSeller > order.escrow) revert ErrOverEscrow();

    // éªŒè¯åŒç­¾
    bytes32 structHash = keccak256(abi.encode(
        SETTLEMENT_TYPEHASH,
        orderId,
        order.tokenAddr,
        amountToSeller,
        proposer,
        acceptor,
        signerNonces[0],  // proposer's nonce
        deadline
    ));
    bytes32 digest = keccak256(abi.encodePacked("\x19\x01", DOMAIN_SEPARATOR, structHash));

    address signer1 = ECDSA.recover(digest, sig1);
    address signer2 = ECDSA.recover(digest, sig2);

    // éªŒè¯ç­¾åè€…æ˜¯ client å’Œ contractor
    require(
        (signer1 == order.client && signer2 == order.contractor) ||
        (signer1 == order.contractor && signer2 == order.client),
        "Invalid signers"
    );

    // éªŒè¯ nonceï¼ˆé˜²é‡æ”¾ï¼‰
    require(nonces[orderId][order.client] == signerNonces[0], "Invalid nonce");
    require(nonces[orderId][order.contractor] == signerNonces[1], "Invalid nonce");
    nonces[orderId][order.client]++;
    nonces[orderId][order.contractor]++;

    // ç»“æ¸…ï¼ˆè®°è´¦ä¸‰ç¬”ï¼ŒåŒ Stage 2ï¼‰
    // ...

    emit AmountSettled(orderId, proposer, acceptor, amountToSeller, signerNonces[0]);
}
```

**æµ‹è¯•**: `test/unit/Signatures.t.sol`
```solidity
function test_SettleWithSigs_CrossOrderReplay() public {
    // è®¢å• 1 çš„ç­¾å
    bytes memory sig1 = _sign(order1, clientPk);
    bytes memory sig2 = _sign(order1, contractorPk);

    // å°è¯•åœ¨è®¢å• 2 ä¸Šé‡æ”¾
    vm.expectRevert("Invalid signers");  // å› ä¸º orderId ä¸åŒ
    nesp.settleWithSigs(order2Id, ..., sig1, sig2);
}

function test_SettleWithSigs_CrossChainReplay() public {
    // åœ¨é“¾ A ä¸Šç­¾å
    vm.chainId(1);
    bytes memory sig1 = _sign(order1, clientPk);

    // å°è¯•åœ¨é“¾ B ä¸Šé‡æ”¾
    vm.chainId(137);  // Polygon
    vm.expectRevert();  // DOMAIN_SEPARATOR ä¸åŒ
    nesp.settleWithSigs(...);
}
```

---

### Stage 4: FeeHook ä¸ ForfeitPoolï¼ˆ2-3 å¤©ï¼‰
**ç›®æ ‡**: å®ç°å¯é€‰æ‰‹ç»­è´¹æœºåˆ¶ä¸ç½šæ²¡æ± æ²»ç†ï¼ˆWP Â§4.1 INV.14, Â§4.3 INV.8ï¼‰

**æˆåŠŸæ ‡å‡†**:
- âœ… FeeHook ä¸º `address(0)` æ—¶ä¸è®¡è´¹
- âœ… æ¶æ„ Hookï¼ˆè¿”å› `fee > amountToSeller`ï¼‰è¢«æ‹’ç»
- âœ… ForfeitPool å…¨é‡èµ„é‡‘æ’ç­‰å¼æµ‹è¯•é€šè¿‡

#### Subtask 4.1: IFeeHook æ¥å£
```solidity
// contracts/interfaces/IFeeHook.sol
interface IFeeHook {
    function onSettleFee(
        uint256 orderId,
        address client,
        address contractor,
        uint256 amountToSeller,
        bytes memory feeCtx
    ) external view returns (address recipient, uint256 fee);
}
```

#### Subtask 4.2: ForfeitPool å®ç°
```solidity
contract NESPCore {
    address public governance;
    mapping(address => uint256) public forfeitBalance;  // INV.8

    modifier onlyGovernance() {
        require(msg.sender == governance, "Not governance");
        _;
    }

    // E13: timeoutForfeit
    function timeoutForfeit(uint256 orderId) external {
        Order storage order = _orders[orderId];

        // å®ˆå«
        if (order.state != OrderState.Disputing) revert ErrInvalidState();
        if (block.timestamp < order.disputeStart + order.disSec) revert ErrInvalidState();

        // ç½šæ²¡
        forfeitBalance[order.tokenAddr] += order.escrow;
        uint256 forfeitedAmount = order.escrow;
        order.escrow = 0;
        order.state = OrderState.Forfeited;

        emit Forfeited(orderId, order.tokenAddr, forfeitedAmount);
    }

    // æ²»ç†ææ¬¾
    function withdrawForfeit(address token, address to, uint256 amount)
        external
        onlyGovernance
        nonReentrant
    {
        require(amount > 0, "Zero amount");
        require(forfeitBalance[token] >= amount, "Insufficient forfeit");

        forfeitBalance[token] -= amount;

        if (token == address(0)) {
            (bool success, ) = to.call{value: amount}("");
            require(success, "ETH transfer failed");
        } else {
            IERC20(token).safeTransfer(to, amount);
        }

        emit ProtocolFeeWithdrawn(token, to, amount, msg.sender);
    }
}
```

**æµ‹è¯•**: `test/unit/ForfeitPool.t.sol`
```solidity
function test_ForfeitPool_Invariant() public {
    // è®¾ç½®ï¼š3 ä¸ªè®¢å•ï¼Œæ€»æ‰˜ç®¡ 300 ETH
    // 1 ä¸ª Settledï¼ˆ100 ETH åˆ†é…ï¼‰
    // 1 ä¸ª Forfeitedï¼ˆ100 ETH ç½šæ²¡ï¼‰
    // 1 ä¸ª Executingï¼ˆ100 ETH æœªç»ˆæ€ï¼‰

    uint256 contractBalance = address(nesp).balance;
    uint256 userBalances = nesp.withdrawableOf(address(0), client)
                         + nesp.withdrawableOf(address(0), contractor);
    uint256 forfeit = nesp.forfeitBalance(address(0));
    uint256 pendingEscrow = 100 ether;  // Executing è®¢å•

    // å…¨é‡èµ„é‡‘æ’ç­‰å¼ï¼ˆINV.8ï¼‰
    assertEq(contractBalance, userBalances + forfeit + pendingEscrow);
}
```

---

### Stage 5: å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆ5-7 å¤©ï¼‰
**ç›®æ ‡**: é›†æˆæµ‹è¯•ã€æ”»å‡»åœºæ™¯æµ‹è¯•ã€Gas ä¼˜åŒ–

**æˆåŠŸæ ‡å‡†**:
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 95%
- âœ… æ‰€æœ‰æ‰¹åˆ¤æ€§è¯„ä»·ä¸­çš„æ”»å‡»åœºæ™¯é€šè¿‡æµ‹è¯•
- âœ… Gas ä¼˜åŒ–å®Œæˆï¼ˆæ¯ä¸ªæ“ä½œ < 100k Gasï¼‰

#### Subtask 5.1: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
```solidity
// test/integration/E2E.t.sol
contract E2ETest is Test {
    function test_Scenario1_NoDispute_FullSettlement() public {
        // 1. åˆ›å»ºè®¢å•
        uint256 orderId = nesp.createAndDeposit{value: 1 ether}(...);

        // 2. å–æ–¹æ¥å•
        vm.prank(contractor);
        nesp.acceptOrder(orderId);

        // 3. å–æ–¹æ ‡è®°å®Œæˆ
        vm.prank(contractor);
        nesp.markReady(orderId);

        // 4. ä¹°æ–¹éªŒæ”¶
        vm.prank(client);
        nesp.approveReceipt(orderId);

        // 5. å–æ–¹æç°
        vm.prank(contractor);
        nesp.withdraw(address(0));

        assertEq(contractor.balance, 1 ether);  // å…¨é¢æ”¶æ¬¾
    }

    function test_Scenario2_Dispute_PartialSettlement() public {
        // ... â†’ raiseDispute â†’ settleWithSigs(A=0.8E)
    }

    function test_Scenario3_Dispute_Timeout_Forfeit() public {
        // ... â†’ raiseDispute â†’ vm.warp(+7 days) â†’ timeoutForfeit
    }
}
```

#### Subtask 5.2: æ”»å‡»åœºæ™¯æµ‹è¯•
```solidity
// test/integration/Attacks.t.sol
contract AttacksTest is Test {
    // æ‰¹åˆ¤æ€§è¯„ä»· Â§4 ç¼ºé™· 10: å‰ç«¯è¿è¡Œæ”»å‡»
    function test_Attack_Frontrunning_DisputeWindow() public {
        // å–æ–¹æäº¤ settleWithSigs(A=0.8E)
        bytes memory sellerTx = abi.encodeCall(nesp.settleWithSigs, (...));

        // ä¹°æ–¹è§‚å¯Ÿåˆ°åï¼Œç«‹å³æäº¤ raiseDisputeï¼ˆGas æ›´é«˜ï¼‰
        vm.prank(client);
        nesp.raiseDispute(orderId);  // å…ˆæ‰§è¡Œ

        // å–æ–¹äº¤æ˜“å¤±è´¥
        vm.expectRevert(NESPCore.ErrInvalidState.selector);
        (bool success, ) = address(nesp).call(sellerTx);
        assertFalse(success);
    }

    // æ‰¹åˆ¤æ€§è¯„ä»· Â§4 ç¼ºé™· 9: æ—¶é—´æˆ³æ“çºµ
    function test_Attack_TimestampManipulation() public {
        // è®¾ç½®ï¼šè·ç¦»è¶…æ—¶è¿˜æœ‰ 10 ç§’
        vm.warp(disputeStart + disSec - 10);

        // å–æ–¹æäº¤ settleWithSigs
        vm.prank(contractor);
        nesp.settleWithSigs(...);

        // çŸ¿å·¥å»¶è¿Ÿ 20 ç§’
        vm.warp(block.timestamp + 20);

        // éªŒè¯ï¼šsettleWithSigs åº”å·²æˆåŠŸï¼ˆåœ¨å»¶è¿Ÿå‰æ‰§è¡Œï¼‰
        assertEq(uint8(nesp.getOrder(orderId).state), uint8(OrderState.Settled));
    }
}
```

#### Subtask 5.3: Gas ä¼˜åŒ–
```bash
# ç”Ÿæˆ Gas å¿«ç…§
forge snapshot

# ä¼˜åŒ–åå¯¹æ¯”
forge snapshot --diff
```

**ä¼˜åŒ–ç›®æ ‡**:
- `createOrder`: < 150k Gas
- `acceptOrder`: < 50k Gas
- `approveReceipt`: < 80k Gas
- `settleWithSigs`: < 120k Gas

---

## éƒ¨ç½²æµç¨‹

### æœ¬åœ°éƒ¨ç½²ï¼ˆAnvilï¼‰
```bash
# å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹
anvil

# éƒ¨ç½²
forge script script/DeployLocal.s.sol --rpc-url http://localhost:8545 --broadcast
```

### æµ‹è¯•ç½‘éƒ¨ç½²ï¼ˆSepoliaï¼‰
```bash
# 1. è·å–æµ‹è¯•å¸
# https://sepoliafaucet.com/

# 2. é…ç½® .env
echo "PRIVATE_KEY_TESTNET=0x..." >> .env
echo "SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/..." >> .env

# 3. éƒ¨ç½²
forge script script/DeployTestnet.s.sol \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY_TESTNET \
  --broadcast \
  --verify

# 4. éªŒè¯åˆçº¦
forge verify-contract <ADDRESS> NESPCore \
  --chain sepolia \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

### ä¸»ç½‘éƒ¨ç½²ï¼ˆâš ï¸ éœ€å®¡è®¡ï¼‰
**å‰ç½®æ¡ä»¶**:
- [ ] è‡³å°‘ 1 å®¶ä¸“ä¸šå®¡è®¡ï¼ˆTrail of Bits / OpenZeppelinï¼‰
- [ ] æ‰€æœ‰ High/Critical é—®é¢˜å·²ä¿®å¤
- [ ] æµ‹è¯•ç½‘è¿è¡Œ â‰¥ 30 å¤©
- [ ] æ²»ç†å¤šç­¾å·²é…ç½®ï¼ˆGnosis Safeï¼‰
- [ ] Bug Bounty å·²å¯åŠ¨ï¼ˆImmunefiï¼‰

```bash
# å¿…é¡»ä½¿ç”¨ç¡¬ä»¶é’±åŒ…ï¼ˆLedgerï¼‰
forge script script/DeployMainnet.s.sol \
  --rpc-url $MAINNET_RPC_URL \
  --ledger \
  --sender <LEDGER_ADDRESS> \
  --broadcast
```

---

## ç§é’¥å®‰å…¨æŒ‡å—

### âœ… æ­£ç¡®åšæ³•

**1. æœ¬åœ°å¼€å‘**ï¼ˆæ— çœŸå®ä»·å€¼ï¼‰
```bash
# Anvil è‡ªåŠ¨æä¾› 10 ä¸ªæµ‹è¯•è´¦æˆ·
# ç§é’¥: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
# åœ°å€: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
```

**2. æµ‹è¯•ç½‘**ï¼ˆæµ‹è¯•å¸ï¼‰
```bash
# æ–¹æ³• A: .envï¼ˆæœ¬åœ°å¼€å‘ï¼‰
echo "PRIVATE_KEY_TESTNET=0x..." >> .env  # æ°¸è¿œä¸æäº¤åˆ° Git

# æ–¹æ³• B: ç¯å¢ƒå˜é‡ï¼ˆCI/CDï¼‰
export PRIVATE_KEY_TESTNET=0x...
forge test --rpc-url $SEPOLIA_RPC_URL
```

**3. ä¸»ç½‘**ï¼ˆçœŸå®èµ„é‡‘ï¼‰
```bash
# å”¯ä¸€æ­£ç¡®æ–¹å¼ï¼šç¡¬ä»¶é’±åŒ…
forge script ... --ledger --mnemonic-index 0
```

### âŒ ç»å¯¹ç¦æ­¢

```bash
# 1. æ°¸è¿œä¸è¦æäº¤ç§é’¥åˆ° Git
git add .env  # âŒ

# 2. æ°¸è¿œä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
const PRIVATE_KEY = "0xabcd...";  // âŒ

# 3. ä¸»ç½‘éƒ¨ç½²æ°¸è¿œä¸è¦ç”¨çº¯æ–‡æœ¬ç§é’¥
forge script ... --private-key 0x...  # âŒï¼ˆä»…é™æµ‹è¯•ç½‘ï¼‰
```

---

## å®¡è®¡æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰å¿…é¡»å®Œæˆ
- [ ] Slither æ‰«æï¼ˆæ—  High/Medium é—®é¢˜ï¼‰
- [ ] Aderyn æ‰«æï¼ˆæ— çº¢è‰²è­¦å‘Šï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 95%
- [ ] æ‰€æœ‰æ‰¹åˆ¤æ€§è¯„ä»·ä¸­çš„æ”»å‡»åœºæ™¯æœ‰æµ‹è¯•
- [ ] Gas ä¼˜åŒ–å®Œæˆï¼ˆå¿«ç…§å¯¹æ¯”ï¼‰
- [ ] æ–‡æ¡£å®Œæ•´ï¼ˆNatSpec æ³¨é‡Šï¼‰

### ä¸“ä¸šå®¡è®¡ï¼ˆä¸»ç½‘å‰å¿…é¡»ï¼‰
- [ ] Trail of Bits / OpenZeppelin / Consensys Diligence
- [ ] å®¡è®¡æŠ¥å‘Šå…¬å¼€å‘å¸ƒ
- [ ] æ‰€æœ‰ Critical/High é—®é¢˜å·²ä¿®å¤
- [ ] Medium é—®é¢˜å·²è¯„ä¼°ï¼ˆæ¥å—æˆ–ä¿®å¤ï¼‰

### æŒç»­ç›‘æ§
- [ ] Tenderly ç›‘æ§ï¼ˆäº¤æ˜“è¿½è¸ªï¼‰
- [ ] Defender Sentinelï¼ˆå¼‚å¸¸å‘Šè­¦ï¼‰
- [ ] Dune Analyticsï¼ˆé“¾ä¸ŠæŒ‡æ ‡é¢æ¿ï¼‰

---

## é‡åˆ°é—®é¢˜æ—¶ï¼ˆ3 æ¬¡å°è¯•åŸåˆ™ï¼‰

**éµå¾ªå…¨å±€ CLAUDE.md çš„"When Stuck"æµç¨‹**ï¼š

1. **è®°å½•å¤±è´¥**ï¼ˆæœ€å¤š 3 æ¬¡å°è¯•ï¼‰
   - å°è¯•äº†ä»€ä¹ˆï¼Ÿ
   - å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Ÿ
   - ä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ

2. **ç ”ç©¶æ›¿ä»£æ–¹æ¡ˆ**
   - æ‰¾ 2-3 ä¸ªç±»ä¼¼å®ç°ï¼ˆUniswap/Aave/OpenZeppelinï¼‰
   - æ¯”è¾ƒä¸åŒæ–¹æ³•

3. **ç®€åŒ–é—®é¢˜**
   - èƒ½å¦æ‹†åˆ†æˆæ›´å°çš„å­é—®é¢˜ï¼Ÿ
   - èƒ½å¦ç§»é™¤æŠ½è±¡ï¼Ÿ

4. **å¯»æ±‚å¸®åŠ©**
   - æé—®åˆ° Foundry Discord / Ethereum Stack Exchange
   - é™„ä¸Šæœ€å°å¯å¤ç°ç¤ºä¾‹ï¼ˆMCVEï¼‰

---

## æäº¤è§„èŒƒ

**éµå¾ª Conventional Commits**:
```
feat(core): implement state transitions E1-E13
test(pull): add reentrancy attack tests
fix(sigs): prevent cross-chain replay attack
docs(readme): add deployment guide
chore(deps): upgrade OpenZeppelin to v5.0.1
```

**æ¯æ¬¡æäº¤å¿…é¡»**:
- âœ… `forge build` ç¼–è¯‘é€šè¿‡
- âœ… `forge test` å…¨éƒ¨é€šè¿‡
- âœ… `forge fmt` æ ¼å¼åŒ–ä»£ç 
- âœ… Commit æ¶ˆæ¯æ¸…æ™°è¯´æ˜"ä¸ºä»€ä¹ˆ"

---

## è¿›åº¦è¿½è¸ª

ä½¿ç”¨ `IMPLEMENTATION_PLAN.md` è®°å½•è¯¦ç»†è¿›åº¦ï¼ˆéµå¾ªå…¨å±€ CLAUDE.mdï¼‰ï¼š

```markdown
## Stage 1: æ ¸å¿ƒçŠ¶æ€æœº
**Status**: In Progress (60%)

### Subtask 1.1: ç±»å‹å®šä¹‰
- [x] å®šä¹‰ OrderState æšä¸¾
- [x] å®šä¹‰ Order ç»“æ„ä½“
- [x] ç¼–å†™å•å…ƒæµ‹è¯•

### Subtask 1.2: çŠ¶æ€è½¬æ¢å®ˆå«
- [x] E1: acceptOrder
- [x] E2: cancelOrder (Initialized)
- [x] E3: markReady
- [ ] E4: approveReceipt (Executing)
- [ ] E5-E13ï¼ˆå‰©ä½™ 9 ä¸ªï¼‰
```

**æ›´æ–°è§„åˆ™**:
- æ¯å®Œæˆä¸€ä¸ª Subtask â†’ æ›´æ–° Markdown
- æ¯å®Œæˆä¸€ä¸ª Stage â†’ Git commit + tagï¼ˆ`v0.1.0-stage1`ï¼‰
- é‡åˆ°é˜»å¡ â†’ è®°å½•åˆ°"é—®é¢˜æ—¥å¿—"éƒ¨åˆ†

---

## æ€»ç»“

### æ—¶é—´ä¼°ç®—
- **Stage 0**: 1-2 å¤©ï¼ˆç¯å¢ƒå‡†å¤‡ï¼‰
- **Stage 1**: 3-5 å¤©ï¼ˆçŠ¶æ€æœºï¼‰
- **Stage 2**: 2-3 å¤©ï¼ˆPull æ¨¡å¼ï¼‰
- **Stage 3**: 2-3 å¤©ï¼ˆç­¾åéªŒè¯ï¼‰
- **Stage 4**: 2-3 å¤©ï¼ˆFeeHook + ForfeitPoolï¼‰
- **Stage 5**: 5-7 å¤©ï¼ˆå®Œæ•´æµ‹è¯•ï¼‰
- **æ€»è®¡**: 15-23 å¤©ï¼ˆçº¦ 3-5 å‘¨ï¼‰

### é£é™©ç¼“è§£
1. **ç§é’¥æ³„éœ²**ï¼šä½¿ç”¨ `.env` + `.gitignore`ï¼Œä¸»ç½‘å¼ºåˆ¶ Ledger
2. **åˆçº¦æ¼æ´**ï¼šå¤šå±‚æµ‹è¯•ï¼ˆå•å…ƒ/é›†æˆ/Fuzzingï¼‰+ ä¸“ä¸šå®¡è®¡
3. **Gas è¿‡é«˜**ï¼šFoundry `snapshot` å¯¹æ¯” + ä¼˜åŒ–è¿­ä»£
4. **æ—¶é—´å»¶è¯¯**ï¼šæ¯ä¸ª Stage ç‹¬ç«‹å¯äº¤ä»˜ï¼Œå¯åˆ†æ‰¹éƒ¨ç½²

### ä¸‹ä¸€æ­¥
1. **ç«‹å³æ‰§è¡Œ**ï¼šåˆå§‹åŒ– Foundry é¡¹ç›®ï¼ˆStage 0ï¼‰
2. **æœ¬å‘¨å®Œæˆ**ï¼šStage 1ï¼ˆçŠ¶æ€æœºéª¨æ¶ï¼‰
3. **æœ¬æœˆå®Œæˆ**ï¼šStage 1-4ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
4. **ä¸‹æœˆå®Œæˆ**ï¼šStage 5ï¼ˆå®Œæ•´æµ‹è¯•ï¼‰+ æµ‹è¯•ç½‘éƒ¨ç½²
